<!-- vi: set filetype=xml : -->
<project name="Java Toolkit" default="deploy" basedir=".">
    
    <!-- build properties -->
    <property environment="env" />
    <property file="${user.home}/user.properties" />
    <property file="build.properties" environment="env" />
    
	<property name="protected.show" value="no" />

	<property name="src.dir" location="src" />

	<property name="src.main.dir" location="${src.dir}/main/java" />
	<property name="src.main.config.dir" location="${src.dir}/main/config" />
	<property name="src.main.resources.dir" location="${src.dir}/main/resources" />
	<property name="src.test.dir" location="${src.dir}/test/java" />

	<property name="target.dir" location="target" />
	<property name="target.config.dir" location="${target.dir}/config" />
	<property name="target.main.classes.dir" location="${target.dir}/classes" />
	<property name="target.test.classes.dir" location="${target.dir}/test-classes" />
	<property name="target.main.lib.dir" location="${target.dir}/lib" />
	<property name="target.test.lib.dir" location="${target.dir}/test-lib" />
	<property name="target.doc.dir" location="${target.dir}/doc" />
	<property name="target.main.toolkit.jar" value="${target.main.lib.dir}/arjtk.jar" />
	<property name="target.test.toolkit.jar" value="${target.test.lib.dir}/arjtk.jar" />

	<property name="logging.config.file" location="${target.config.dir}/logging.properties" />
	<property name="extlib.dir" location="lib" />
	<property name="reports.dir" location="${target.dir}/test_reports" />

    <property name="target.sourceforge" value="${target.dir}${file.separator}sourceforge" />

	<property environment="site_env" />
	<property file="site-ref.properties" />

	<target name="site-props" description="Show location properties of site-specific parameters">
		<echo message="SITE_CLASSPATH=${site_env.SITE_CLASSPATH}" />
		<echo message="SITE_PROPS_FILE=${site_env.SITE_PROPS_FILE}" />
	</target>
    
	<!-- Targets -->
	<target name="demo"
		description="Run a basic demonstration application that uses the toolkit">

		<java classname="com.ausregistry.jtoolkit2.demo.Demo">
			<arg value="1" />
			<classpath>
				<fileset dir="${extlib.dir}">
					<include name="**/*.jar" />
				</fileset>

				<fileset dir="${target.main.lib.dir}">
					<include name="**/*.jar" />
				</fileset>

			    <fileset dir="${target.dir}${file.separator}config">
                    <include name="**/*.properties" />
                </fileset>
			</classpath>
		</java>
	</target>

	<target name="compile"
		description="Compile Java EPP Toolkit core classes (no unit tests)">

		<mkdir dir="${target.dir}" />
		<mkdir dir="${target.main.classes.dir}" />
        <copy todir="${target.main.classes.dir}">
            <fileset dir="${src.main.resources.dir}">
                 <include name="**/*.xsd" />
                <include name="**/*.properties" />
             </fileset>
         </copy>

		<javac includeantruntime="false"
			srcdir="${src.main.dir}" destdir="${target.main.classes.dir}"
			debug="on" deprecation="on"
			source="1.6" target="1.6">

			<exclude name="**/package-info.java" />
			<compilerarg value="-Xlint:unchecked" />

			<classpath>
				<fileset dir="${extlib.dir}">
					<include name="**/*.jar" />
				</fileset>
			</classpath>
		</javac>
	</target>

	<target name="lib" description="Java EPP Toolkit Library" depends="compile">
		<mkdir dir="${target.main.lib.dir}" />

		<jar jarfile="${target.main.toolkit.jar}" basedir="${target.main.classes.dir}" />

		<copy todir="${target.main.lib.dir}">
			<fileset dir="${extlib.dir}">
				<include name="**/*.jar" />
			</fileset>
		</copy>
	</target>

	<target name="deploy"
		description="Create and deploy jar file; copy configuration and resource files to target location"
		depends="lib">

		<mkdir dir="${target.config.dir}" />

		<copy todir="${target.config.dir}">
			<fileset dir="${src.main.config.dir}" />
		</copy>

		<jar jarfile="${target.main.toolkit.jar}" basedir="${src.main.resources.dir}" update="true" />
	</target>

	<target name="compiletests"
		description="Compile Java EPP Toolkit unit test classes"
		depends="lib">

		<mkdir dir="${target.test.classes.dir}" />

		<javac includeantruntime="false"
			srcdir="${src.test.dir}"
			destdir="${target.test.classes.dir}"
			debug="on" deprecation="on"
			source="1.6" target="1.6">

			<exclude name="**/package-info.java" />
			<compilerarg value="-Xlint:unchecked" />

			<classpath>
				<fileset dir="${target.main.lib.dir}">
					<include name="**/*.jar" />
				</fileset>
			</classpath>
		</javac>
	</target>

	<target name="testlib"
		description="Java EPP Toolkit Library with Unit Tests"
		depends="compiletests">

		<mkdir dir="${target.test.lib.dir}" />

		<jar jarfile="${target.test.toolkit.jar}"
			basedir="${target.test.classes.dir}" />
	</target>

	<target name="deploytests"
		description="Create and deploy jar file with JUnit tests; copy configuration and resource files to target location"
		depends="testlib">

		<mkdir dir="${target.config.dir}" />

		<copy todir="${target.config.dir}">
			<fileset dir="${src.main.config.dir}" />
		</copy>

		<jar jarfile="${target.main.toolkit.jar}" basedir="${src.main.resources.dir}" update="true" />
	</target>

	<target name="tests" description="Run JUnit tests" depends="deploytests">
		<mkdir dir="${reports.dir}"/>

		<junit fork="yes" failureproperty="tests.failed" printsummary="true" forkmode="once">
			<formatter type="xml" />

			<classpath>
				<fileset dir="${target.main.lib.dir}">
					<include name="**/*.jar" />
				</fileset>

				<fileset dir="${target.test.lib.dir}">
					<include name="**/*.jar" />
				</fileset>

				<fileset dir="${target.config.dir}">
					<include name="**/*.jar" />
				</fileset>

				<pathelement location="${target.config.dir}" />
				<pathelement path="${site_env.SITE_CLASSPATH}" />
			</classpath>

			<jvmarg value="-Xmx256M"/>
			<jvmarg value="-Dtoolkit.cfg.dir=${target.config.dir}"/>
			<jvmarg value="-Dtime.real=false"/>
			<jvmarg value="-Djava.util.logging.config.file=${logging.config.file}"/>
			<jvmarg value="-Dsite.properties.file=${site_env.SITE_PROPS_FILE}"/>
			<jvmarg value="-Dfile.encoding=UTF-8"/>

			<batchtest fork="yes" todir="${reports.dir}">
				<fileset dir="${src.test.dir}">
					<exclude name="**/PerfTest.java"/>
					<exclude name="**/SessionTest.java"/>
					<exclude name="**/SessionManagerTest.java"/>
				</fileset>
			</batchtest>
		</junit>
		
        <mkdir dir="${reports.dir}/html" />
        <junitreport todir="${reports.dir}">
            <fileset dir="${reports.dir}" includes="**/TEST*xml" excludes="**/TEST*-TestSuites.xml" />
            <report format="frames" todir="${reports.dir}/html" />
        </junitreport>
		
		<fail if="tests.failed" message="tests failed" />
	</target>

	<target name="doc"
		description="Java EPP Toolkit Documentation">

		<mkdir dir="${target.doc.dir}" />

		<javadoc destdir="${target.doc.dir}"
			public="yes"
			protected="${protected.show}">
			<!--doclet="${doclet.class}" docletpath="${doclet.jar}"-->

			<packageset dir="${src.main.dir}" />

			<classpath>
				<fileset dir="${extlib.dir}">
					<include name="**/*.jar" />
				</fileset>
			</classpath>
		</javadoc>
	</target>

	<target name="clean" description="Clean generated files">
		<delete includeEmptyDirs="true" quiet="true">
			<fileset dir="${target.dir}" />
		</delete>
	</target>
</project>

